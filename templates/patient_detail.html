{% extends "base.html" %}

{% block title %}
{% if patient %}{{ patient.get_full_name() }} - Patient Details{% else %}New Patient Registration{% endif %} - Community Health System
{% endblock %}

{% block content %}
<div class="container my-4">
    <!-- Patient Header -->
    {% if patient %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                         style="width: 60px; height: 60px;">
                                        <i class="fas fa-user fa-lg"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h3 class="mb-1">{{ patient.get_full_name() }}</h3>
                                    <p class="text-muted mb-0">
                                        <i class="fas fa-id-card me-2"></i>{{ patient.patient_number }}
                                        {% if patient.national_id %}
                                        <span class="mx-2">|</span>
                                        <i class="fas fa-id-badge me-2"></i>{{ patient.national_id }}
                                        {% endif %}
                                        {% if patient.nhif_number %}
                                        <span class="mx-2">|</span>
                                        <i class="fas fa-credit-card me-2"></i>NHIF: {{ patient.nhif_number }}
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <a href="{{ url_for('edit_patient', id=patient.id) }}" class="btn btn-outline-primary me-2">
                                <i class="fas fa-edit me-1"></i>Edit Patient
                            </a>
                            <a href="{{ url_for('new_health_record', id=patient.id) }}" class="btn btn-success">
                                <i class="fas fa-plus me-1"></i>Add Record
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Information Tabs -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <ul class="nav nav-tabs card-header-tabs" id="patientTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" 
                                    data-bs-target="#overview" type="button" role="tab">
                                <i class="fas fa-user me-2"></i>Overview
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="health-records-tab" data-bs-toggle="tab" 
                                    data-bs-target="#health-records" type="button" role="tab">
                                <i class="fas fa-file-medical me-2"></i>Health Records
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="payments-tab" data-bs-toggle="tab" 
                                    data-bs-target="#payments" type="button" role="tab">
                                <i class="fas fa-money-bill-wave me-2"></i>Payments
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="patientTabsContent">
                        <!-- Overview Tab -->
                        <div class="tab-pane fade show active" id="overview" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-info-circle me-2"></i>Personal Information
                                    </h6>
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Full Name:</strong></td>
                                            <td>{{ patient.get_full_name() }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Date of Birth:</strong></td>
                                            <td>{{ patient.date_of_birth.strftime('%d %B %Y') }} ({{ patient.get_age() }} years)</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Gender:</strong></td>
                                            <td>
                                                <span class="badge bg-{{ 'primary' if patient.gender == 'male' else 'pink' if patient.gender == 'female' else 'secondary' }}">
                                                    {{ patient.gender.title() }}
                                                </span>
                                            </td>
                                        </tr>
                                        {% if patient.blood_group %}
                                        <tr>
                                            <td><strong>Blood Group:</strong></td>
                                            <td><span class="badge bg-danger">{{ patient.blood_group }}</span></td>
                                        </tr>
                                        {% endif %}
                                        <tr>
                                            <td><strong>Phone:</strong></td>
                                            <td>{{ patient.phone_number or 'Not provided' }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Email:</strong></td>
                                            <td>{{ patient.email or 'Not provided' }}</td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-map-marker-alt me-2"></i>Address & Location
                                    </h6>
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>County:</strong></td>
                                            <td>{{ patient.county.title() if patient.county else 'Not specified' }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Sub-County:</strong></td>
                                            <td>{{ patient.subcounty or 'Not specified' }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Ward:</strong></td>
                                            <td>{{ patient.ward or 'Not specified' }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Village:</strong></td>
                                            <td>{{ patient.village or 'Not specified' }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Address:</strong></td>
                                            <td>{{ patient.address_line or 'Not provided' }}</td>
                                        </tr>
                                    </table>

                                    <h6 class="text-primary mb-3 mt-4">
                                        <i class="fas fa-phone me-2"></i>Emergency Contact
                                    </h6>
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Name:</strong></td>
                                            <td>{{ patient.emergency_contact_name or 'Not provided' }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Phone:</strong></td>
                                            <td>{{ patient.emergency_contact_phone or 'Not provided' }}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>

                            {% if patient.allergies or patient.chronic_conditions %}
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-exclamation-triangle me-2"></i>Medical Alerts
                                    </h6>
                                    <div class="row">
                                        {% if patient.allergies %}
                                        <div class="col-md-6">
                                            <div class="alert alert-warning">
                                                <h6><i class="fas fa-allergies me-2"></i>Known Allergies</h6>
                                                <p class="mb-0">{{ patient.allergies }}</p>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% if patient.chronic_conditions %}
                                        <div class="col-md-6">
                                            <div class="alert alert-info">
                                                <h6><i class="fas fa-heartbeat me-2"></i>Chronic Conditions</h6>
                                                <p class="mb-0">{{ patient.chronic_conditions }}</p>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Health Records Tab -->
                        <div class="tab-pane fade" id="health-records" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="text-primary mb-0">
                                    <i class="fas fa-file-medical me-2"></i>Health Records
                                </h6>
                                <a href="{{ url_for('new_health_record', id=patient.id) }}" class="btn btn-success btn-sm">
                                    <i class="fas fa-plus me-1"></i>New Record
                                </a>
                            </div>

                            {% if health_records %}
                                {% for record in health_records %}
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <div class="row align-items-center">
                                            <div class="col-md-6">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-calendar me-2"></i>
                                                    {{ record.encounter_date.strftime('%d %B %Y, %I:%M %p') }}
                                                </h6>
                                                <small class="text-muted">{{ record.encounter_type.replace('_', ' ').title() }}</small>
                                            </div>
                                            <div class="col-md-6 text-md-end">
                                                {% if record.provider_id %}
                                                <small class="text-muted">
                                                    Provider: {{ record.provider_id }}
                                                </small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                {% if record.chief_complaint %}
                                                <p><strong>Chief Complaint:</strong><br>{{ record.chief_complaint }}</p>
                                                {% endif %}
                                                {% if record.diagnosis %}
                                                <p><strong>Diagnosis:</strong><br>{{ record.diagnosis }}</p>
                                                {% endif %}
                                                {% if record.treatment_plan %}
                                                <p><strong>Treatment Plan:</strong><br>{{ record.treatment_plan }}</p>
                                                {% endif %}
                                                {% if record.medications_prescribed %}
                                                <p><strong>Medications:</strong><br>{{ record.medications_prescribed }}</p>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-6">
                                                <h6>Vital Signs</h6>
                                                <div class="row g-2">
                                                    {% if record.weight %}
                                                    <div class="col-6">
                                                        <small><strong>Weight:</strong> {{ record.weight }} kg</small>
                                                    </div>
                                                    {% endif %}
                                                    {% if record.height %}
                                                    <div class="col-6">
                                                        <small><strong>Height:</strong> {{ record.height }} cm</small>
                                                    </div>
                                                    {% endif %}
                                                    {% if record.temperature %}
                                                    <div class="col-6">
                                                        <small><strong>Temperature:</strong> {{ record.temperature }}°C</small>
                                                    </div>
                                                    {% endif %}
                                                    {% if record.blood_pressure_systolic and record.blood_pressure_diastolic %}
                                                    <div class="col-6">
                                                        <small><strong>BP:</strong> {{ record.blood_pressure_systolic }}/{{ record.blood_pressure_diastolic }} mmHg</small>
                                                    </div>
                                                    {% endif %}
                                                    {% if record.pulse_rate %}
                                                    <div class="col-6">
                                                        <small><strong>Pulse:</strong> {{ record.pulse_rate }} bpm</small>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                {% if record.follow_up_date %}
                                                <p class="mt-2">
                                                    <strong>Follow-up:</strong> {{ record.follow_up_date.strftime('%d %B %Y') }}
                                                </p>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-file-medical fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No health records found</h5>
                                <p class="text-muted">Start by adding the patient's first health record.</p>
                                <a href="{{ url_for('new_health_record', id=patient.id) }}" class="btn btn-success">
                                    <i class="fas fa-plus me-2"></i>Add First Record
                                </a>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Payments Tab -->
                        <div class="tab-pane fade" id="payments" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="text-primary mb-0">
                                    <i class="fas fa-money-bill-wave me-2"></i>Payment History
                                </h6>
                                <a href="{{ url_for('new_payment', patient_id=patient.id) }}" class="btn btn-warning btn-sm">
                                    <i class="fas fa-plus me-1"></i>New Payment
                                </a>
                            </div>

                            {% if payments %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Reference</th>
                                                <th>Amount</th>
                                                <th>Type</th>
                                                <th>Status</th>
                                                <th>Date</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for payment in payments %}
                                            <tr>
                                                <td>
                                                    <small class="font-monospace">{{ payment.payment_reference }}</small>
                                                </td>
                                                <td>
                                                    <strong>KES {{ "%.2f"|format(payment.amount) }}</strong>
                                                </td>
                                                <td>
                                                    <span class="badge bg-info">{{ payment.payment_type.replace('_', ' ').title() }}</span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-{{ 'success' if payment.status == 'completed' else 'warning' if payment.status == 'pending' else 'danger' }}">
                                                        {{ payment.status.title() }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <small>{{ payment.created_at.strftime('%d %b %Y') }}</small>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No payments found</h5>
                                <p class="text-muted">No payment transactions recorded for this patient.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- New Patient Registration Form -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user-plus me-2"></i>Patient Registration
                    </h5>
                </div>
                <div class="card-body">
                    {% if form %}
                    <form method="POST" novalidate>
                        {{ form.hidden_tag() }}
                        
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-user me-2"></i>Personal Information
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.first_name.label(class="form-label fw-bold") }}
                                {{ form.first_name(class="form-control" + (" is-invalid" if form.first_name.errors else "")) }}
                                {% if form.first_name.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.first_name.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                {{ form.last_name.label(class="form-label fw-bold") }}
                                {{ form.last_name(class="form-control" + (" is-invalid" if form.last_name.errors else "")) }}
                                {% if form.last_name.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.last_name.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ form.national_id.label(class="form-label fw-bold") }}
                                {{ form.national_id(class="form-control" + (" is-invalid" if form.national_id.errors else ""), placeholder="12345678") }}
                                {% if form.national_id.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.national_id.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                {{ form.nhif_number.label(class="form-label fw-bold") }}
                                {{ form.nhif_number(class="form-control" + (" is-invalid" if form.nhif_number.errors else "")) }}
                                {% if form.nhif_number.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.nhif_number.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                {{ form.date_of_birth.label(class="form-label fw-bold") }}
                                {{ form.date_of_birth(class="form-control" + (" is-invalid" if form.date_of_birth.errors else "")) }}
                                {% if form.date_of_birth.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.date_of_birth.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ form.gender.label(class="form-label fw-bold") }}
                                {{ form.gender(class="form-select" + (" is-invalid" if form.gender.errors else "")) }}
                                {% if form.gender.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.gender.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                {{ form.blood_group.label(class="form-label fw-bold") }}
                                {{ form.blood_group(class="form-select" + (" is-invalid" if form.blood_group.errors else "")) }}
                                {% if form.blood_group.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.blood_group.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                {{ form.phone_number.label(class="form-label fw-bold") }}
                                {{ form.phone_number(class="form-control" + (" is-invalid" if form.phone_number.errors else ""), placeholder="0712345678") }}
                                {% if form.phone_number.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.phone_number.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                {{ form.email.label(class="form-label fw-bold") }}
                                {{ form.email(class="form-control" + (" is-invalid" if form.email.errors else "")) }}
                                {% if form.email.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.email.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <h6 class="text-primary mb-3 mt-4">
                            <i class="fas fa-map-marker-alt me-2"></i>Address Information
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                {{ form.county.label(class="form-label fw-bold") }}
                                {{ form.county(class="form-select" + (" is-invalid" if form.county.errors else "")) }}
                                {% if form.county.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.county.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                {{ form.subcounty.label(class="form-label fw-bold") }}
                                {{ form.subcounty(class="form-control" + (" is-invalid" if form.subcounty.errors else "")) }}
                                {% if form.subcounty.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.subcounty.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                {{ form.ward.label(class="form-label fw-bold") }}
                                {{ form.ward(class="form-control" + (" is-invalid" if form.ward.errors else "")) }}
                                {% if form.ward.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.ward.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                {{ form.village.label(class="form-label fw-bold") }}
                                {{ form.village(class="form-control" + (" is-invalid" if form.village.errors else "")) }}
                                {% if form.village.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.village.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                {{ form.address_line.label(class="form-label fw-bold") }}
                                {{ form.address_line(class="form-control" + (" is-invalid" if form.address_line.errors else ""), rows="2") }}
                                {% if form.address_line.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.address_line.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <h6 class="text-primary mb-3 mt-4">
                            <i class="fas fa-heartbeat me-2"></i>Medical Information
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.allergies.label(class="form-label fw-bold") }}
                                {{ form.allergies(class="form-control" + (" is-invalid" if form.allergies.errors else ""), rows="2") }}
                                {% if form.allergies.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.allergies.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                {{ form.chronic_conditions.label(class="form-label fw-bold") }}
                                {{ form.chronic_conditions(class="form-control" + (" is-invalid" if form.chronic_conditions.errors else ""), rows="2") }}
                                {% if form.chronic_conditions.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.chronic_conditions.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <h6 class="text-primary mb-3 mt-4">
                            <i class="fas fa-phone me-2"></i>Emergency Contact
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.emergency_contact_name.label(class="form-label fw-bold") }}
                                {{ form.emergency_contact_name(class="form-control" + (" is-invalid" if form.emergency_contact_name.errors else "")) }}
                                {% if form.emergency_contact_name.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.emergency_contact_name.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                {{ form.emergency_contact_phone.label(class="form-label fw-bold") }}
                                {{ form.emergency_contact_phone(class="form-control" + (" is-invalid" if form.emergency_contact_phone.errors else ""), placeholder="0712345678") }}
                                {% if form.emergency_contact_phone.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.emergency_contact_phone.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="d-flex gap-3 mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Register Patient
                            </button>
                            <a href="{{ url_for('patients') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                        </div>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Add Health Record Form (when add_record is True) -->
    {% if add_record and patient %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-plus me-2"></i>Add Health Record for {{ patient.get_full_name() }}
                    </h5>
                </div>
                <div class="card-body">
                    {% if form %}
                    <form method="POST" novalidate>
                        {{ form.hidden_tag() }}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.encounter_type.label(class="form-label fw-bold") }}
                                {{ form.encounter_type(class="form-select" + (" is-invalid" if form.encounter_type.errors else "")) }}
                                {% if form.encounter_type.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.encounter_type.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                {{ form.facility_name.label(class="form-label fw-bold") }}
                                {{ form.facility_name(class="form-control" + (" is-invalid" if form.facility_name.errors else ""), value=current_user.facility_name or "") }}
                                {% if form.facility_name.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.facility_name.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <h6 class="text-success mb-3 mt-4">
                            <i class="fas fa-thermometer-half me-2"></i>Vital Signs
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-2 mb-3">
                                {{ form.weight.label(class="form-label fw-bold") }}
                                {{ form.weight(class="form-control" + (" is-invalid" if form.weight.errors else "")) }}
                                {% if form.weight.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.weight.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-2 mb-3">
                                {{ form.height.label(class="form-label fw-bold") }}
                                {{ form.height(class="form-control" + (" is-invalid" if form.height.errors else "")) }}
                                {% if form.height.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.height.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-2 mb-3">
                                {{ form.temperature.label(class="form-label fw-bold") }}
                                {{ form.temperature(class="form-control" + (" is-invalid" if form.temperature.errors else "")) }}
                                {% if form.temperature.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.temperature.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold">Blood Pressure</label>
                                <div class="input-group">
                                    {{ form.blood_pressure_systolic(class="form-control" + (" is-invalid" if form.blood_pressure_systolic.errors else ""), placeholder="120") }}
                                    <span class="input-group-text">/</span>
                                    {{ form.blood_pressure_diastolic(class="form-control" + (" is-invalid" if form.blood_pressure_diastolic.errors else ""), placeholder="80") }}
                                </div>
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                {{ form.pulse_rate.label(class="form-label fw-bold") }}
                                {{ form.pulse_rate(class="form-control" + (" is-invalid" if form.pulse_rate.errors else "")) }}
                                {% if form.pulse_rate.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.pulse_rate.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <h6 class="text-success mb-3 mt-4">
                            <i class="fas fa-notes-medical me-2"></i>Clinical Information
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.chief_complaint.label(class="form-label fw-bold") }}
                                {{ form.chief_complaint(class="form-control" + (" is-invalid" if form.chief_complaint.errors else ""), rows="3") }}
                                {% if form.chief_complaint.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.chief_complaint.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                {{ form.diagnosis.label(class="form-label fw-bold") }}
                                {{ form.diagnosis(class="form-control" + (" is-invalid" if form.diagnosis.errors else ""), rows="3") }}
                                {% if form.diagnosis.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.diagnosis.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.treatment_plan.label(class="form-label fw-bold") }}
                                {{ form.treatment_plan(class="form-control" + (" is-invalid" if form.treatment_plan.errors else ""), rows="3") }}
                                {% if form.treatment_plan.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.treatment_plan.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                {{ form.medications_prescribed.label(class="form-label fw-bold") }}
                                {{ form.medications_prescribed(class="form-control" + (" is-invalid" if form.medications_prescribed.errors else ""), rows="3") }}
                                {% if form.medications_prescribed.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.medications_prescribed.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.follow_up_date.label(class="form-label fw-bold") }}
                                {{ form.follow_up_date(class="form-control" + (" is-invalid" if form.follow_up_date.errors else "")) }}
                                {% if form.follow_up_date.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.follow_up_date.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="d-flex gap-3 mt-4">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-2"></i>Save Health Record
                            </button>
                            <a href="{{ url_for('patient_detail', id=patient.id) }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                        </div>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-calculate BMI if weight and height are provided
    const weightInput = document.querySelector('input[name="weight"]');
    const heightInput = document.querySelector('input[name="height"]');
    
    if (weightInput && heightInput) {
        function calculateBMI() {
            const weight = parseFloat(weightInput.value);
            const height = parseFloat(heightInput.value);
            
            if (weight && height) {
                const bmi = weight / Math.pow(height / 100, 2);
                console.log(`BMI: ${bmi.toFixed(1)}`);
            }
        }
        
        weightInput.addEventListener('input', calculateBMI);
        heightInput.addEventListener('input', calculateBMI);
    }
    
    // Phone number formatting
    const phoneInputs = document.querySelectorAll('input[type="tel"]');
    phoneInputs.forEach(input => {
        input.addEventListener('input', function() {
            let value = this.value.replace(/\D/g, '');
            if (value.startsWith('254')) {
                value = '+' + value;
            } else if (value.startsWith('0')) {
                value = '+254' + value.substring(1);
            } else if (value.length === 9) {
                value = '+254' + value;
            }
            this.value = value;
        });
    });
});
</script>
{% endblock %}
